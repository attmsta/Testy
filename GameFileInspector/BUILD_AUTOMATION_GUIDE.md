# üöÄ Build Automation Guide (Updated for GitLab CI)

## Overview

This guide covers the comprehensive build automation system for Game File Inspector, primarily focusing on the GitLab CI/CD pipeline and local build scripts.

## üîÑ Automated Build Workflows

This project uses **GitLab CI/CD** for continuous integration and deployment. The entire CI/CD pipeline configuration for the Android application, including build, test, security scans, and release, is defined in `GameFileInspector/.gitlab-ci.yml`.

### GitLab CI/CD Pipeline (`GameFileInspector/.gitlab-ci.yml`)

The `GameFileInspector/.gitlab-ci.yml` file defines the complete pipeline for the Android application.

#### Pipeline Stages
The pipeline is structured with the following stages, executed in order:
1.  **`prepare`**: Sets up the build environment, installs dependencies (like Android SDK tools), and prepares necessary configurations. Caches relevant directories (`$PROJECT_SUBDIR/.gradle/`, `$PROJECT_SUBDIR/app/build/`, `$PROJECT_SUBDIR/build/`) to speed up subsequent runs.
2.  **`test`**: Executes unit tests (`./gradlew test`) and lint checks (`./gradlew lint`). Test results (JUnit XML) and lint reports are saved as artifacts. This stage also includes a `security_scan` job for basic checks.
3.  **`secret-detection`**: Performs automated secret detection using the `Security/Secret-Detection.gitlab-ci.yml` template. This helps identify accidental credential leaks.
4.  **`build`**: Compiles debug (`./gradlew assembleDebug`) and release (`./gradlew assembleRelease`) versions of the APK. The resulting APKs are saved as artifacts. This stage might have separate jobs for debug and release builds, triggered on different conditions (e.g., debug for all branches, release for `main` and tags). It also includes a `nightly_build` job.
5.  **`release`**: Creates a GitLab Release when changes are pushed to the `main` branch or a tag is created. This job uses the `release-cli` image, takes the release APK from the `build_release` job, generates release notes, and attaches the APK to the GitLab Release. A `deploy_manual` job is also available in this stage.

*(Other jobs like `performance_test` run in the `test` stage, and `cleanup` runs in a `.post` stage.)*

#### Key Features & Capabilities
- ‚úÖ **Automatic APK Building**: Triggered by pushes to specific branches (e.g., `main`, `develop`) and tags.
- ‚úÖ **Comprehensive Testing**: Includes unit tests and lint analysis.
- ‚úÖ **Artifact Management**: APKs, test reports, and other build outputs are stored as artifacts with configurable retention periods (e.g., `expire_in`).
- ‚úÖ **Automated GitLab Releases**: New releases are automatically created with APKs and detailed release notes.
- ‚úÖ **Environment Variables**: Uses GitLab CI/CD variables for configuration (e.g., `ANDROID_COMPILE_SDK`, `ANDROID_BUILD_TOOLS`).
- ‚úÖ **Caching**: Caches Gradle dependencies and build outputs to accelerate pipeline execution.
- ‚úÖ **Conditional Job Execution**: Jobs can be restricted to run only on specific branches or tags using the `only` keyword.

#### Accessing Build Artifacts and Logs
- **Build Logs**: Available directly within the "CI/CD" > "Pipelines" section of the GitLab repository. Each pipeline run shows detailed logs for every job.
- **APKs and Other Artifacts**:
    - Can be downloaded directly from completed jobs in a pipeline run.
    - Release APKs are attached to GitLab Releases.

## üõ†Ô∏è Local Build Script (`build_apk.sh`)

### Features
The local build script (`build_apk.sh`, if present, or manual Gradle commands) provides capabilities for local APK building:

```bash
# Example: Build debug APK using Gradle wrapper (from GameFileInspector directory)
./gradlew assembleDebug

# Example: Build release APK using Gradle wrapper (from GameFileInspector directory)
./gradlew assembleRelease

# Example: Clean build artifacts (from GameFileInspector directory)
./gradlew clean
```
*(If a `build_apk.sh` script exists, its specific commands and options should be documented here. The commands above assume execution from within the `GameFileInspector` directory, where `gradlew` is located.)*

### Build Process (General, using Gradle)
1. **Environment Validation**: Ensure JDK, Android SDK, and Gradle are correctly set up.
2. **Dependency Resolution**: Gradle downloads and caches dependencies.
3. **Testing** (optional but recommended): `(cd GameFileInspector && ./gradlew test lintDebug)`
4. **Compilation**: `(cd GameFileInspector && ./gradlew assembleDebug)` or `(cd GameFileInspector && ./gradlew assembleRelease)`
5. **Reporting**: Build reports are generated by Gradle in `GameFileInspector/app/build/reports/`.

## üì¶ Release Management

### GitLab Releases
- **Trigger**: Typically configured in the `GameFileInspector/.gitlab-ci.yml` file for pushes to the `main` branch or new tags.
- **Process**: The `release` job in `GameFileInspector/.gitlab-ci.yml` uses `registry.gitlab.com/gitlab-org/release-cli` to create a release. It includes release notes and a link to the release APK artifact.
- **Assets**: The primary asset is the release APK (e.g., `app-release-unsigned.apk`).
- **Versioning**: The release name and tag often use `$CI_COMMIT_SHORT_SHA` or `$CI_COMMIT_TAG`.
- **Access**: Releases are available under the "Deploy" > "Releases" section of the GitLab repository.

### Release Artifacts
Each CI/CD pipeline run that completes a build stage will produce:
- üì± **Release APK** (if `assembleRelease` is run)
- üì± **Debug APK** (if `assembleDebug` is run)
- üìä **Test Reports** (JUnit XML, lint reports)
- üìù **Release Notes** (for releases created by the pipeline)

## üîß Build Configuration (Gradle)

The primary build configuration is within `build.gradle` (module-level) and `build.gradle` (project-level) files in the `GameFileInspector` directory.

```gradle
// Example from GameFileInspector/app/build.gradle
android {
    compileSdk 34
    
    defaultConfig {
        applicationId "com.gamefileinspector"
        minSdk 21 // Note: Original .gitlab-ci.yml used minSdk 24 in release notes text
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        debug {
            // Debug specific configs
        }
        release {
            minifyEnabled false // As per original .gitlab-ci.yml, though typically true for release
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            // Signing config would be here for signed releases
        }
    }
}
```

## üß™ Testing Integration

The GitLab CI/CD pipeline in `GameFileInspector/.gitlab-ci.yml` integrates various forms of testing:
- **Unit Tests**: Executed via `(cd $PROJECT_SUBDIR && ./gradlew test)`.
- **Lint Analysis**: Executed via `(cd $PROJECT_SUBDIR && ./gradlew lint)`.
- **Security Scans**:
    - A `security_scan` job performs basic checks for hardcoded secrets and manifest issues (part of the `test` stage).
    - Automated secret detection is integrated via the `secret-detection` stage using GitLab's standard template.
- **Test Reporting**: JUnit XML reports are generated and can be integrated with GitLab for display. Artifacts path: `$PROJECT_SUBDIR/app/build/test-results/` and `$PROJECT_SUBDIR/app/build/reports/`.

## üîí Security and Signing

### Security Measures in CI/CD
- **Secret Detection**: Integrated into the pipeline via the `secret-detection` stage in `GameFileInspector/.gitlab-ci.yml`, using the `Security/Secret-Detection.gitlab-ci.yml` template. This is controlled by the `SECRET_DETECTION_ENABLED: 'true'` variable in the CI file.
- **Basic Security Checks**: The `security_scan` job in the `test` stage performs additional checks for hardcoded secrets in source code and common Android manifest issues.

### APK Signing
- The provided `GameFileInspector/.gitlab-ci.yml` builds an `app-release-unsigned.apk`.
- For actual production releases, APK signing must be configured. This typically involves:
    1.  Generating a keystore.
    2.  Storing keystore information securely (e.g., using GitLab CI/CD protected variables).
    3.  Updating `GameFileInspector/app/build.gradle` to use these variables for signing the release build.

## üöÄ Deployment Strategies

### Development Deployment
- Debug APKs from feature branches can be used for testing. These are built by the `build_debug` job in GitLab CI.

### Production Deployment
- Release APKs generated from the `main` branch or tags are published to GitLab Releases via the `release` job in GitLab CI.

### Distribution Channels
- **GitLab Releases**: Primary channel for distributing built APKs.
- **Direct APK Download**: From pipeline artifacts for testing/internal use.

## üõ†Ô∏è Troubleshooting CI/CD

### Common GitLab CI/CD Issues
- **Pipeline Failures**: Check job logs in GitLab CI/CD for error messages.
- **Environment Issues**: Ensure `image: openjdk:17-jdk` is appropriate and `before_script` correctly installs all dependencies. The `before_script` in `GameFileInspector/.gitlab-ci.yml` handles Android SDK setup.
- **Android SDK Problems**: Verify paths and that `sdkmanager` commands succeed. `ANDROID_HOME` is set to `$PWD/android-sdk-linux` relative to the job's working directory.
- **Gradle Errors**: Examine Gradle output in the job logs. Running Gradle commands with `--stacktrace` (as done in the CI file) provides more details. Remember commands are run from the `GameFileInspector` subdirectory context in the CI script (e.g., `(cd GameFileInspector && ./gradlew... )` if the yml is at root, or just `./gradlew` if yml is in `GameFileInspector` and workspace is set there). The current CI file is in `GameFileInspector/` and assumes it's the working dir.
- **Cache Issues**: Sometimes clearing the GitLab CI/CD cache (if problematic) or adjusting cache paths can help. Cache paths in `GameFileInspector/.gitlab-ci.yml` are `.gradle/`, `app/build/`, `build/` relative to `GameFileInspector/`.

## üìö Quick Reference

### Important Files
- `GameFileInspector/.gitlab-ci.yml`: The sole CI/CD pipeline configuration file for the Android application, including build, test, security scanning (secret detection), and release processes.
- `GameFileInspector/build.gradle`: Project and app module Gradle build scripts.
- `GameFileInspector/gradlew`: Gradle wrapper script, executed from within `GameFileInspector/` as orchestrated by the CI pipeline.

### Support Resources
- **Documentation**: This guide and other markdown files in the repository.
- **Issue Tracking**: GitLab Issues for the project.
- **Build Logs**: Detailed execution logs for each job in GitLab CI/CD pipelines.

This build automation system, centered around GitLab CI/CD, facilitates reliable and consistent builds, testing, and releases for the Game File Inspector application.
